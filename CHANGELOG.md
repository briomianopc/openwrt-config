# 更新日志

## 2025-11-01 - 重大重构和 Docker 化

### 🎯 前端改进 (index.html)

#### 新增功能
- ✅ **完整的 Kconfig 表达式解析器**
  - 支持逻辑运算符：`&&`, `||`, `!`
  - 支持比较运算符：`==`, `!=`, `<`, `>`, `<=`, `>=`
  - 支持括号分组和复杂嵌套表达式
  - 使用调度场算法（Shunting Yard）实现中缀转后缀
  - 栈式求值后缀表达式

- ✅ **自动选择逻辑 (selects)**
  - 使用 Vue 3 的 `watch` 监听器实时监控配置变化
  - 自动勾选被依赖的选项
  - 锁定自动选择的选项，防止用户误操作
  - 视觉反馈：蓝色斜体显示 + "[自动选择]" 标记

- ✅ **异步数据加载**
  - 移除硬编码的 MOCK_MENU_JSON
  - 使用 `fetch` API 异步加载真实的 menu.json
  - 添加 loading 和 error 状态
  - 更好的用户体验

- ✅ **改进的菜单树构建**
  - 使用 Map 数据结构优化树构建
  - 支持任意深度的菜单嵌套
  - 正确处理 menu_path 层级关系
  - 处理没有路径的选项

- ✅ **组件状态管理优化**
  - 使用 Vue 3 的 `provide/inject` API
  - 替代不安全的 `app._instance` 访问
  - 更符合 Vue 3 最佳实践

- ✅ **UI/UX 改进**
  - 添加 loading 状态显示
  - 添加错误提示
  - 禁用项灰色显示
  - 锁定项蓝色显示
  - Debug 信息只显示启用的选项

### 🔧 后端改进 (api.py)

#### 修复的问题
- ❌ 硬编码路径 → ✅ 环境变量配置
- ❌ 无静态文件服务 → ✅ 添加 Flask 静态文件路由
- ❌ 并发冲突风险 → ✅ 使用线程锁保护
- ❌ 缺少日志 → ✅ 完整的日志系统
- ❌ 配置备份缺失 → ✅ 自动备份和恢复

#### 新增功能
- ✅ **静态文件服务**
  - `GET /` - 返回 index.html
  - `GET /menu.json` - 返回配置菜单
  - 集成前后端，无需单独服务器

- ✅ **健康检查端点**
  - `GET /health` - 返回服务健康状态
  - 检查 OpenWrt 源码是否存在
  - 检查 menu.json 是否存在

- ✅ **环境变量配置**
  - `OPENWRT_SRC_PATH` - 源码路径
  - `STATIC_DIR` - 静态文件目录
  - `CORS_ORIGINS` - CORS 配置
  - `DEBUG` - 调试模式
  - `PORT` - 服务端口

- ✅ **改进的错误处理**
  - 更详细的错误信息
  - 异常日志记录
  - 超时处理（120秒）
  - 自动清理临时文件

- ✅ **并发安全**
  - 使用线程锁防止 make defconfig 冲突
  - 临时目录隔离
  - .config 文件备份和恢复

- ✅ **生产环境支持**
  - 使用 Gunicorn WSGI 服务器
  - 日志配置
  - 启动前环境检查

### 🔧 Kconfig 解析器改进 (parse_kconfig.py)

#### 修复的问题
- ❌ 硬编码路径 → ✅ 环境变量 + 命令行参数
- ❌ 无参数支持 → ✅ argparse 完整参数
- ❌ 缺少检查 → ✅ 路径存在性检查
- ❌ 错误处理不足 → ✅ 完善的异常处理

#### 新增功能
- ✅ **命令行参数**
  - `--src-path` - 指定源码路径
  - `--output` - 指定输出文件
  - `--verbose` - 详细输出

- ✅ **环境变量支持**
  - `OPENWRT_SRC_PATH` - 源码路径
  - `OUTPUT_JSON_PATH` - 输出路径

- ✅ **更好的错误处理**
  - 路径存在性检查
  - 详细的错误提示
  - 退出码规范

- ✅ **自动创建目录**
  - 自动创建输出目录
  - 避免路径错误

### 🐳 Docker 化部署

#### 新增文件
- ✅ **Dockerfile**
  - 基于 Python 3.11-slim
  - 安装 OpenWrt 构建依赖
  - 多阶段构建优化
  - 健康检查配置
  - Gunicorn 生产服务器

- ✅ **docker-compose.yml**
  - 服务定义
  - 卷挂载配置
  - 环境变量配置
  - 网络配置
  - 健康检查
  - 自动重启策略

- ✅ **.dockerignore**
  - 排除不必要的文件
  - 优化构建速度
  - 减小镜像大小

- ✅ **requirements.txt**
  - Flask 3.0.0
  - Flask-CORS 4.0.0
  - kconfiglib 14.1.0
  - Gunicorn 21.2.0

- ✅ **.env.example**
  - 环境变量模板
  - 详细的配置说明

### 📚 文档

#### 新增文档
- ✅ **README.md**
  - 项目介绍
  - 快速开始指南
  - 配置说明
  - API 文档
  - 故障排除
  - 安全建议
  - 性能优化

- ✅ **DEPLOYMENT.md**
  - 部署前检查清单
  - 详细部署步骤
  - 部署后验证
  - 故障排查指南
  - 生产环境建议
  - 监控建议
  - 更新和维护

- ✅ **CHANGELOG.md**
  - 详细的变更记录
  - 功能对比
  - 升级说明

### 🛠️ 工具脚本

- ✅ **start.sh**
  - 自动化启动脚本
  - 环境检查
  - 配置验证
  - 一键部署
  - 健康检查
  - 自动生成 menu.json

## 功能对比

### 修复前 ❌

| 功能 | 状态 |
|------|------|
| 依赖解析 | 仅支持单个依赖 |
| 自动选择 | 不支持 |
| 菜单树 | 简化版，不够健壮 |
| 数据加载 | 硬编码模拟数据 |
| 静态文件 | 需要单独服务器 |
| 并发安全 | 无保护 |
| 日志系统 | 简单 print |
| 配置方式 | 硬编码 |
| 部署方式 | 手动 |
| 文档 | 无 |

### 修复后 ✅

| 功能 | 状态 |
|------|------|
| 依赖解析 | 完整表达式解析器 |
| 自动选择 | 完整支持 + 锁定 |
| 菜单树 | Map 优化，任意深度 |
| 数据加载 | 异步 fetch，状态管理 |
| 静态文件 | 集成到 Flask |
| 并发安全 | 线程锁保护 |
| 日志系统 | 完整 logging 配置 |
| 配置方式 | 环境变量 + 命令行 |
| 部署方式 | Docker + 一键脚本 |
| 文档 | 完整文档 + 指南 |

## 升级指南

### 从旧版本升级

1. **备份数据**
```bash
cp menu.json menu.json.backup
```

2. **拉取最新代码**
```bash
git pull
```

3. **配置环境变量**
```bash
cp .env.example .env
# 编辑 .env 文件
vim .env
```

4. **使用 Docker 部署**
```bash
# 编辑 docker-compose.yml
vim docker-compose.yml

# 启动服务
./start.sh
```

5. **重新生成 menu.json**
```bash
docker-compose exec openwrt-config-generator python parse_kconfig.py
```

### 兼容性说明

- ✅ 向后兼容：旧的 menu.json 文件格式仍然支持
- ✅ API 兼容：`/generate-config` 端点保持不变
- ⚠️ 配置方式改变：建议使用环境变量替代硬编码

## 已知问题

暂无

## 计划功能

- [ ] 搜索功能实现
- [ ] 配置导入/导出
- [ ] 配置历史记录
- [ ] 配置对比功能
- [ ] 多语言支持
- [ ] 配置模板保存

## 贡献者

- 初始版本：原作者
- 重构和 Docker 化：2025-11-01

## 反馈

如有问题或建议，请提交 Issue。
